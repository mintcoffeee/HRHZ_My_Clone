<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="categorySQL">

	<select id ="getCategoryBestProductList" parameterType="java.util.List" resultType="java.util.Map">
		SELECT 
*
FROM  (SELECT 
   rownum as seq,
    k.*
            
        FROM (SELECT 
                   p.code AS "productCode"
                ,   p.name AS "productName"
              ,   P.brand_code as "brandCode"
              ,   (P.brand_code || '/' ||  pi.img_origin_name)as "imgPath"
                ,   (SELECT name FROM brand WHERE  code = p.brand_code) as "brandName" 
                ,    TO_CHAR(p.price, 'FM999,999,999,999') AS "price"
                ,   p.like_count AS "likeCount"
                , p.color as "color"
              ,   ROW_NUMBER() OVER(PARTITION BY p.code ORDER BY PI.SEQ DESC) AS "RN"
            FROM   product p
                INNER JOIN (SELECT  a.product_code
                                 ,  a.img_origin_name
                                , MIN(a.seq) AS SEQ
                            FROM   product_image a
                            WHERE  a.thumbanil_yn = 'Y'
                            GROUP  BY a.product_code, a.img_origin_name
                          ) pi
              ON p.code = pi.product_code
            WHERE  
               1 = 1
               <if test='colorArr != null'>
                AND color IN 
            <foreach item="item" index="index" collection="colorArr" open="(" separator="," close=")">
            #{item}
          </foreach>
       	 </if>
           
                ORDER  BY p.like_count DESC
             ) k
      WHERE 
            1=1
        AND k.RN = 1
        )
        where 
        1=1
        AND seq <![CDATA[>=]]> #{startNum} AND seq <![CDATA[<=]]> #{endNum}
    </select>
    
    <!-- totalA -->
    <select id="getTotalA" resultType="int">
    	select count(*)             
        FROM (SELECT 
                   p.code AS "productCode"
                ,   p.name AS "productName"
              ,   P.brand_code as "brandCode"
              ,   (P.brand_code || '/' ||  pi.img_origin_name)as "imgPath"
                ,   (SELECT name FROM brand WHERE  code = p.brand_code) as "brandName" 
                ,    TO_CHAR(p.price, 'FM999,999,999,999') AS "price"
                ,   p.like_count AS "likeCount"
                , p.color as "color"
              ,   ROW_NUMBER() OVER(PARTITION BY p.code ORDER BY PI.SEQ DESC) AS "RN"
            FROM   product p
                INNER JOIN (SELECT  a.product_code
                                 ,  a.img_origin_name
                                , MIN(a.seq) AS SEQ
                            FROM   product_image a
                            WHERE  a.thumbanil_yn = 'Y'
                            GROUP  BY a.product_code, a.img_origin_name
                          ) pi
              ON p.code = pi.product_code
            WHERE  
               1 = 1
                <if test='colorArr != null'>
                
                AND color IN #{colorArr}
               
            </if>
                ORDER  BY p.like_count DESC
             ) k
      WHERE 
            1=1
        AND k.RN = 1
     
       
    </select>
    
    
    <!-- like Count -->
    
    <insert id="categorylikeInsert" parameterType="java.util.HashMap">
    	INSERT INTO like_list
    	VALUES (#{id} 
    	<choose>
			<when test ='codeType != null and codeType == "B"'>
				, #{code}
			</when>
			<otherwise>
				, null
			</otherwise>
		</choose>
		<choose>
			<when test ='codeType != null and codeType == "P"'>
				, #{code}
			</when>
			<otherwise>
				, null
			</otherwise>
		</choose>
			, #{codeType}
    		, sysdate
    	) 
    </insert>
    
     <delete id="categorylikeDelete" parameterType="java.util.Map">
    	DELETE FROM like_list
    	WHERE 1=1
    	<if test='codeType != null and codeType == "B"'>
            AND brand_code = #{code}
        </if>
        <if test='codeType != null and codeType == "P"'>
            AND product_code= #{code}
        </if>
        	AND id = #{id}
    	
    </delete>
    
    <update id="categorylikeCount" parameterType="java.util.Map">
    	UPDATE 
    	<if test='codeType != null and codeType == "B"'>
        	BRAND
        </if>
        <if test='codeType != null and codeType == "P"'>
            PRODUCT
        </if>
        SET
        	<if test='division != null and division == "I"'>
            	like_count = like_count + 1
        	</if>
        	<if test='division != null and division == "D"'>
        		like_count = like_count - 1
        	</if>
        WHERE 1=1
        <if test='codeType != null and codeType == "B"'>
            AND code = #{code}
        </if>
        <if test='codeType != null and codeType == "P"'>
            AND code= #{code}
        </if> 
    </update>
    
    <!-- colorSelectProdutList -->
    


</mapper>