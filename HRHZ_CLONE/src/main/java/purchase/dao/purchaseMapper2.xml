<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="purchaseSQL2">
    <select id="getPaymentInfo" parameterType="payment" resultType="payment">
        select
            "imgPath", "brandName", "productCode", "productName", "productPrice",
            pd.code as "optionCode", "detailType", pd.name as "optionName"
        from
            (select
                p.code as "productCode"
                , p.name as "productName"
                , p.brand_code as "brandCode"
                , (select name from brand where code=p.brand_code) as "brandName"
                , to_char(p.price, 'FM999,999,999,999') as "productPrice"
                , (p.brand_code || '/' || pi.img_origin_name) as "imgPath"
                , ROW_NUMBER() OVER(PARTITION BY p.code ORDER BY PI.SEQ DESC) AS "RN"
                , p.detail_type as "detailType"
            from product p
                join (select a.product_code
                            , a.img_origin_name
                            , min(a.seq) as seq
                      from product_image a
                      where a.thumbanil_yn = 'Y'
                      GROUP BY a.product_code, a.img_origin_name
                     ) pi
                on p.code = pi.product_code
            where
                p.code=#{productCode}
            )
            join (select
                        *
                 from product_detail b
                 where
                        b.code = #{optionCode}
                 ) pd
            on "productCode"= pd.product_code
        where
            RN = 1
    </select>

</mapper>