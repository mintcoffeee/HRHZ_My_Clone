<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="purchaseSQL">

    <select id="getProductDetail" parameterType="String" resultType="map">
	    SELECT p.name AS "productName", detail_type AS "detailType",
	    	   price AS "price", "LIKE" AS "like", p."COMMENT" AS "comment",
		       pd.name AS "detailName",
		       b.code AS "brandCode", b.name AS "brandName",
		       bi.img_path AS "brandImgPath", img_name AS "brandImgName"
		FROM product p
		JOIN product_detail pd ON p.code=pd.product_code
		JOIN brand b ON p.brand_code=b.code
		JOIN brand_image bi ON p.brand_code=bi.brand_code
		WHERE p.code = #{productCode}
	</select>

	<select id="getProductImages" parameterType="String" resultType="map">
		SELECT brand_code AS "brandCode", img_origin_name AS "imgName", thumbanil_yn AS "thumbnailYn"
		FROM product
		JOIN product_image ON code=product_code
		WHERE product_code = #{productCode}
    </select>

	<select id="getProductReviews" parameterType="String" resultType="map">
		SELECT 
		        
		       r.seq                             	AS "seq",
		       ri.seq                            	AS "imgSeq",
		       r.member_id                       	AS "memberId",
		       r.content                         	AS "content",
		       r.like_count                         AS "like",
		       To_char(r.reg_date, 'YYYY.MM.DD') 	AS "regDate",
		       ri.img_origin_name                	AS "imgName",
		       (ri.img_path || ri.img_origin_name)  AS "imgPath"
		FROM   review r
		       inner join (SELECT seq,
		                          review_seq,
		                          img_origin_name,
		                          img_path
		                   FROM   review_image) ri
		               ON r.seq = ri.review_seq
		WHERE  1 = 1
		       AND product_code = 'P00000072'
		       order by r.seq
    </select>
    
    <select id="getReviewSeq" resultType="int">
    	SELECT seq_review.NEXTVAL FROM DUAL
    </select>
    
    <insert id="reviewUpload" parameterType="review">
    	INSERT INTO review VALUES(#{seq}, #{productCode}, #{brandCode}, #{memberId},
    							  #{content}, #{like}, SYSDATE, NULL)
    </insert>
    
    <insert id="reviewImageUpload" parameterType="reviewImage">
    	INSERT INTO review_image VALUES(seq_reviewimage.NEXTVAL, #{reviewSeq},
    							  #{imgOriginName}, #{imgPath}, #{regId}, NULL, SYSDATE, NULL)
    </insert>
    
</mapper>